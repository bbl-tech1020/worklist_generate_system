{% extends 'dashboard/index.html' %}
{% load static %}

{% block header %}
<header class="navbar navbar-expand-md navbar-light d-print-none">
  <div class="container-fluid">
    <h1 class="navbar-brand">文件替换</h1>
  </div>
  {% include "dashboard/partials/user_toolbar.html" %}
</header>
{% endblock %}

{% block content %}
<style>
  .replace-title {
    font-weight: 700;
    margin: 12px 0 10px;
  }

  .hint {
    color: #6c757d;
    font-size: 13px;
    margin-top: 6px;
  }

  .barcode-input {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    letter-spacing: .2px;
  }

  .readonly-pill {
    background: #f6f7f9;
  }

  .op-btns {
    display: inline-flex;
    gap: 8px;
  }

  /* ===== 表头美化 ===== */
  .used-table thead th,
  .nouse-table thead th {
    font-size: 16px;
    /* 表头字体变大 */
    font-weight: 700;
    text-align: center;
    /* 水平居中 */
    vertical-align: middle;
    /* 垂直居中 */
    padding: 12px 8px;
  }

  /* ===== 表体输入框美化 ===== */
  .used-table tbody td,
  .nouse-table tbody td {
    vertical-align: middle;
  }

  .used-table input.form-control,
  .nouse-table input.form-control {
    height: 40px;
    /* 输入框高度 */
    font-size: 15px;
    padding: 8px 10px;
  }

  /* 只读孔位样式更“禁用感”一点 */
  .used-table input[readonly] {
    background-color: #f5f6f8;
    color: #555;
  }

  /* ===== 操作按钮（添加 / 删除）放大 ===== */
  .used-table .btn,
  .nouse-table .btn {
    font-size: 14px;
    padding: 6px 14px;
    min-width: 64px;
  }

  /* 操作列居中 */
  .used-table td:last-child,
  .nouse-table td:last-child {
    text-align: center;
  }

  /* ===== 提交按钮区域 ===== */
  .submit-bar {
    display: flex;
    justify-content: flex-start;
    /* 提交按钮靠左 */
    margin-top: 16px;
  }
</style>

<form method="post" enctype="multipart/form-data" id="replace-form">
  {% csrf_token %}

  <div class="card mt-4">
    <div class="card-body">

      <div class="mb-3">
        <label class="form-label">替换文件</label>
        <!-- ✅ 补上 id，后续你写联动逻辑会更方便 -->
        <input type="file" class="form-control" id="replace_file" name="replace_file">
        <div class="hint">请上传需要替换的上机列表文件</div>
      </div>

      <div class="mb-3">
        <label class="form-label">替换操作</label>
        <select class="form-select" id="replace_reason" name="replace_reason" required>
          <option value="">请选择替换操作</option>
          <option value="used">已用孔位替换（如扫错条码）</option>
          <option value="nouse">未用孔位替换（如样本量不足，存在剩余孔位）</option>
        </select>
        <input type="hidden" id="project-name" name="project_name">
      </div>

      <!-- ✅ 已用孔位替换区域：先只做展示与添加行，不写孔位关联逻辑 -->
      <div id="used-panel" style="display:none;">
        <div class="replace-title">已用孔位替换</div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle used-table">
            <thead class="table-light">
              <tr>
                <th style="width: 34%;">当前条码</th>
                <th style="width: 16%;">孔位（VialPos）</th>
                <th style="width: 34%;">新条码</th>
                <th style="width: 16%;">操作</th>
              </tr>
            </thead>
            <tbody id="used-tbody">
              <!-- 行由 JS 动态生成 -->
            </tbody>
          </table>
        </div>

        <div class="hint">说明：孔位（VialPos）后续会在输入“当前条码”后自动从上传文件中匹配带出；现在先展示占位。</div>
      </div>

      <!-- ✅ 未用孔位替换区域（nouse） -->
      <div id="nouse-panel" style="display:none;">
        <div class="replace-title">未用孔位替换</div>

        <div class="table-responsive">
          <table class="table table-sm table-bordered align-middle nouse-table">
            <thead class="table-light">
              <tr>
                <th style="width: 40%;">新条码</th>
                <th style="width: 30%;">孔位（VialPos）</th>
                <th style="width: 30%;">操作</th>
              </tr>
            </thead>
            <tbody id="nouse-tbody">
              <!-- 行由 JS 动态生成 -->
            </tbody>
          </table>
        </div>

        <div class="hint">说明：未用孔位替换需要手动填写“新条码”和“孔位”，可点击“添加”增加多条。</div>
      </div>


      <div class="mt-3 submit-bar">
        <button type="submit" class="btn btn-primary">提交</button>
      </div>

    </div>
  </div>
</form>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const replaceReasonSelect = document.getElementById('replace_reason');
    const usedPanel = document.getElementById('used-panel');
    const usedTbody = document.getElementById('used-tbody');

    const nousePanel = document.getElementById('nouse-panel');
    const nouseTbody = document.getElementById('nouse-tbody');

    function createUsedRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>
          <input type="text"
                 class="form-control form-control-sm barcode-input"
                 name="used_old_barcode[]"
                 placeholder="请输入当前条码">
        </td>
        <td>
          <!-- 先不写关联逻辑：只读占位 -->
          <input type="text"
                 class="form-control form-control-sm readonly-pill"
                 name="used_vialpos[]"
                 placeholder="自动关联"
                 readonly>
        </td>
        <td>
          <input type="text"
                 class="form-control form-control-sm barcode-input"
                 name="used_new_barcode[]"
                 placeholder="请输入新条码">
        </td>
        <td class="text-center">
          <div class="op-btns">
            <button type="button" class="btn btn-outline-primary btn-sm btn-add">添加</button>
            <button type="button" class="btn btn-outline-danger btn-sm btn-del">删除</button>
          </div>
        </td>
      `;

      // 添加：新增一行
      tr.querySelector('.btn-add').addEventListener('click', () => {
        usedTbody.appendChild(createRow());
      });

      // 删除：删除当前行（至少保留 1 行）
      tr.querySelector('.btn-del').addEventListener('click', () => {
        if (usedTbody.children.length <= 1) return;
        tr.remove();
      });

      return tr;
    }

    // ===== 未用孔位替换（nouse）行 =====
    function createNouseRow() {
      const tr = document.createElement('tr');
      tr.innerHTML = `
      <td>
        <input type="text"
               class="form-control form-control-sm barcode-input"
               name="nouse_new_barcode[]"
               placeholder="请输入新条码">
      </td>
      <td>
        <input type="text"
               class="form-control form-control-sm barcode-input"
               name="nouse_vialpos[]"
               placeholder="请输入孔位（VialPos）">
      </td>
      <td class="text-center">
        <div class="op-btns">
          <button type="button" class="btn btn-outline-primary btn-sm btn-add">添加</button>
          <button type="button" class="btn btn-outline-danger btn-sm btn-del">删除</button>
        </div>
      </td>
    `;

      // 添加一行
      tr.querySelector('.btn-add').addEventListener('click', () => {
        nouseTbody.appendChild(createNouseRow());
      });

      // 删除当前行（至少保留 1 行）
      tr.querySelector('.btn-del').addEventListener('click', () => {
        if (nouseTbody.children.length <= 1) return;
        tr.remove();
      });

      return tr;
    }

    // ===== 根据 replace_reason 切换显示 =====
    replaceReasonSelect.addEventListener('change', () => {
      const val = replaceReasonSelect.value;

      if (val === 'used') {
        usedPanel.style.display = 'block';
        nousePanel.style.display = 'none';

        // 默认一行（若你 used 已经做了，这段按你的实际保留/删除）
        if (usedTbody.children.length === 0) {
          usedTbody.appendChild(createUsedRow());
        }
      } else if (val === 'nouse') {
        usedPanel.style.display = 'none';
        nousePanel.style.display = 'block';

        // 默认一行
        if (nouseTbody.children.length === 0) {
          nouseTbody.appendChild(createNouseRow());
        }
      } else {
        usedPanel.style.display = 'none';
        nousePanel.style.display = 'none';
      }
    });
  });
</script>
{% endblock %}