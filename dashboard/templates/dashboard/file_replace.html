{% extends 'dashboard/index.html' %}
{% load static %}

{% block header %}
<header class="navbar navbar-expand-md navbar-light d-print-none">
    <div class="container-fluid">
        <h1 class="navbar-brand">文件替换</h1>
    </div>
    {% include "dashboard/partials/user_toolbar.html" %}
</header>
{% endblock %}

{% block content %}
<style>
    .replace-title {
        font-weight: 700;
        margin: 12px 0 10px;
    }

    .hint {
        color: #6c757d;
        font-size: 13px;
        margin-top: 6px;
    }

    .barcode-input {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        letter-spacing: .2px;
    }

    .readonly-pill {
        background: #f6f7f9;
    }

    .op-btns {
        display: inline-flex;
        gap: 8px;
    }

    /* ===== 表头美化 ===== */
    .used-table thead th,
    .nouse-table thead th {
        font-size: 16px;
        /* 表头字体变大 */
        font-weight: 700;
        text-align: center;
        /* 水平居中 */
        vertical-align: middle;
        /* 垂直居中 */
        padding: 12px 8px;
    }

    /* ===== 表体输入框美化 ===== */
    .used-table tbody td,
    .nouse-table tbody td {
        vertical-align: middle;
    }

    .used-table input.form-control,
    .nouse-table input.form-control {
        height: 40px;
        /* 输入框高度 */
        font-size: 15px;
        padding: 8px 10px;
    }

    /* 只读孔位样式更“禁用感”一点 */
    .used-table input[readonly] {
        background-color: #f5f6f8;
        color: #555;
    }

    /* ===== 操作按钮（添加 / 删除）放大 ===== */
    .used-table .btn,
    .nouse-table .btn {
        font-size: 14px;
        padding: 6px 14px;
        min-width: 64px;
    }

    /* 操作列居中 */
    .used-table td:last-child,
    .nouse-table td:last-child {
        text-align: center;
    }

    /* ===== 提交按钮区域 ===== */
    .submit-bar {
        display: flex;
        justify-content: flex-start;
        /* 提交按钮靠左 */
        margin-top: 16px;
    }

    /* 当前条码未匹配：孔位框标红 + 提示文字 */
    .vialpos-invalid {
        border-color: #dc3545 !important;
        background-color: #fff5f5;
    }

    .vialpos-hint {
        font-size: 12px;
        margin-top: 4px;
        color: #dc3545;
        display: none;
    }

    .vialpos-hint.show {
        display: block;
    }
</style>

<form method="post" enctype="multipart/form-data" id="replace-form">
    {% csrf_token %}

    <div class="card mt-4">
        <div class="card-body">

            <div class="mb-3">
                <label class="form-label">替换文件</label>
                <!-- ✅ 补上 id，后续你写联动逻辑会更方便 -->
                <input type="file" class="form-control" id="replace_file" name="replace_file">
                <div class="hint">请上传需要替换的上机列表文件</div>
            </div>

            <div class="mb-3">
                <label class="form-label">替换操作</label>
                <select class="form-select" id="replace_reason" name="replace_reason" required>
                    <option value="">请选择替换操作</option>
                    <option value="used">已用孔位替换（如扫错条码）</option>
                    <option value="nouse">未用孔位替换（如样本量不足，存在剩余孔位）</option>
                </select>
                <input type="hidden" id="project-name" name="project_name">
            </div>

            <!-- ✅ 已用孔位替换区域：先只做展示与添加行，不写孔位关联逻辑 -->
            <div id="used-panel" style="display:none;">
                <div class="replace-title">已用孔位替换</div>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle used-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 34%;">当前条码</th>
                                <th style="width: 16%;">孔位（VialPos）</th>
                                <th style="width: 34%;">新条码</th>
                                <th style="width: 16%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="used-tbody">
                            <!-- 行由 JS 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <div class="hint">说明：孔位（VialPos）后续会在输入“当前条码”后自动从上传文件中匹配带出；现在先展示占位。</div>
            </div>

            <!-- ✅ 未用孔位替换区域（nouse） -->
            <div id="nouse-panel" style="display:none;">
                <div class="replace-title">未用孔位替换</div>

                <div class="table-responsive">
                    <table class="table table-sm table-bordered align-middle nouse-table">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 40%;">新条码</th>
                                <th style="width: 30%;">孔位（VialPos）</th>
                                <th style="width: 30%;">操作</th>
                            </tr>
                        </thead>
                        <tbody id="nouse-tbody">
                            <!-- 行由 JS 动态生成 -->
                        </tbody>
                    </table>
                </div>

                <div class="hint">说明：未用孔位替换需要手动填写“新条码”和“孔位”，可点击“添加”增加多条。</div>
            </div>


            <div class="mt-3 submit-bar">
                <button type="submit" class="btn btn-primary">提交</button>
            </div>

        </div>
    </div>
</form>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 解析用户上传的上机列表
        const replaceFileInput = document.getElementById('replace_file');

        // 条码 -> 孔位 的映射表
        let barcodeToVialPos = new Map();
        let parsedOK = false;

        // 识别分隔符：逗号/制表符/分号（你们文件有时是 \t）
        function guessDelimiter(line) {
            const tab = (line.match(/\t/g) || []).length;
            const comma = (line.match(/,/g) || []).length;
            const semi = (line.match(/;/g) || []).length;
            if (tab >= comma && tab >= semi) return '\t';
            if (comma >= semi) return ',';
            return ';';
        }

        // 表头容错：比如第一格是 "% header=SampleName"
        function normalizeHeader(h) {
            return (h || '')
                .replace(/^%?\s*header\s*=\s*/i, '')
                .trim()
                .toLowerCase();
        }

        // 孔位清洗：如果含进样盘号，只取“最后一段”
        // 例： "1-20004" / "1:20004" / "Rack1 20004" -> "20004"
        function cleanVialPos(raw) {
            const s = (raw || '').trim();
            if (!s) return '';
            // 按常见分隔符切
            const parts = s.split(/[\s:\-_]+/).filter(Boolean);
            return parts.length ? parts[parts.length - 1] : s;
        }

        // 解析文件：第一列为条码列；孔位列名可能是 VialPos / Vial position
        function parseOnboardingText(text) {
            const lines = text.split(/\r?\n/).filter(l => l.trim().length > 0);
            if (lines.length < 2) return { ok: false, msg: '文件内容不足，无法解析。' };

            const delimiter = guessDelimiter(lines[0]);
            const rawHeaders = lines[0].split(delimiter);
            const headers = rawHeaders.map(normalizeHeader);

            // 条码列：需求说“第一列”，所以默认 index=0
            // 但为了稳，也允许识别 sample/samplename
            let barcodeIdx = 0;
            const idxSample = headers.findIndex(h => h === 'sample' || h === 'samplename');
            if (idxSample !== -1) barcodeIdx = idxSample;

            // 孔位列：可能为 vialpos / vial position
            const vialIdx = headers.findIndex(h => h === 'vialpos' || h === 'vial position');
            if (vialIdx === -1) {
                return { ok: false, msg: `未找到孔位列（VialPos / Vial position），当前表头：${rawHeaders.join(' | ')}` };
            }

            const map = new Map();
            for (let i = 1; i < lines.length; i++) {
                const cols = lines[i].split(delimiter);
                const barcode = (cols[barcodeIdx] || '').trim();
                const vialRaw = (cols[vialIdx] || '').trim();
                if (!barcode) continue;
                map.set(barcode, cleanVialPos(vialRaw));
            }
            return { ok: true, map };
        }

        // 上传文件后解析建立映射
        replaceFileInput.addEventListener('change', async (e) => {
            parsedOK = false;
            barcodeToVialPos = new Map();

            const file = e.target.files && e.target.files[0];
            if (!file) return;

            const text = await file.text();
            const res = parseOnboardingText(text);
            if (!res.ok) {
                alert('解析失败：' + res.msg);
                return;
            }
            barcodeToVialPos = res.map;
            parsedOK = true;
        });

        // 根据用户选择的功能模块弹出不同的面板
        const replaceReasonSelect = document.getElementById('replace_reason');
        const usedPanel = document.getElementById('used-panel');
        const usedTbody = document.getElementById('used-tbody');

        const nousePanel = document.getElementById('nouse-panel');
        const nouseTbody = document.getElementById('nouse-tbody');

        function createUsedRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                <input type="text"
                        class="form-control form-control-sm barcode-input"
                        name="used_old_barcode[]"
                        placeholder="请输入当前条码">
                </td>
                <td>
                    <input type="text"
                        class="form-control form-control-sm readonly-pill used-vialpos"
                        name="used_vialpos[]"
                        placeholder="自动关联"
                        readonly>
                    <div class="vialpos-hint">条码不在上机列表中</div>
                </td>
                <td>
                <input type="text"
                        class="form-control form-control-sm barcode-input"
                        name="used_new_barcode[]"
                        placeholder="请输入新条码">
                </td>
                <td class="text-center">
                <div class="op-btns">
                    <button type="button" class="btn btn-outline-primary btn-sm btn-add">添加</button>
                    <button type="button" class="btn btn-outline-danger btn-sm btn-del">删除</button>
                </div>
                </td>
            `;

            const oldInput = tr.querySelector('input[name="used_old_barcode[]"]');
            const vialInput = tr.querySelector('.used-vialpos');
            const hint = tr.querySelector('.vialpos-hint');

            oldInput.addEventListener('input', () => {
            const code = oldInput.value.trim();

            // 先清理状态
            vialInput.value = '';
            vialInput.classList.remove('vialpos-invalid');
            hint.classList.remove('show');

            if (!code) return;

            // 未上传/未解析成功，先不做匹配（你也可以提示）
            if (!parsedOK) return;

            const vialPos = barcodeToVialPos.get(code);
            if (!vialPos) {
                // 找不到：孔位标红 + 显示提示
                vialInput.classList.add('vialpos-invalid');
                hint.classList.add('show');
                return;
            }

            // 找到：写入孔位（已做 cleanVialPos 截盘号）
            vialInput.value = vialPos;
            });

            // 添加：新增一行
            tr.querySelector('.btn-add').addEventListener('click', () => {
                usedTbody.appendChild(createUsedRow());
            });

            // 删除：删除当前行（至少保留 1 行）
            tr.querySelector('.btn-del').addEventListener('click', () => {
                if (usedTbody.children.length <= 1) return;
                tr.remove();
            });

            return tr;
        }

        // ===== 未用孔位替换（nouse）行 =====
        function createNouseRow() {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>
                    <input type="text"
                        class="form-control form-control-sm barcode-input"
                        name="nouse_new_barcode[]"
                        placeholder="请输入新条码">
                </td>
                <td>
                    <input type="text"
                        class="form-control form-control-sm barcode-input"
                        name="nouse_vialpos[]"
                        placeholder="请输入孔位（VialPos）">
                </td>
                <td class="text-center">
                    <div class="op-btns">
                    <button type="button" class="btn btn-outline-primary btn-sm btn-add">添加</button>
                    <button type="button" class="btn btn-outline-danger btn-sm btn-del">删除</button>
                    </div>
                </td>
                `;

            // 添加一行
            tr.querySelector('.btn-add').addEventListener('click', () => {
                nouseTbody.appendChild(createNouseRow());
            });

            // 删除当前行（至少保留 1 行）
            tr.querySelector('.btn-del').addEventListener('click', () => {
                if (nouseTbody.children.length <= 1) return;
                tr.remove();
            });

            return tr;
        }

        // ===== 根据 replace_reason 切换显示 =====
        replaceReasonSelect.addEventListener('change', () => {
            const val = replaceReasonSelect.value;

            if (val === 'used') {
                usedPanel.style.display = 'block';
                nousePanel.style.display = 'none';

                // 默认一行（若你 used 已经做了，这段按你的实际保留/删除）
                if (usedTbody.children.length === 0) {
                    usedTbody.appendChild(createUsedRow());
                }
            } else if (val === 'nouse') {
                usedPanel.style.display = 'none';
                nousePanel.style.display = 'block';

                // 默认一行
                if (nouseTbody.children.length === 0) {
                    nouseTbody.appendChild(createNouseRow());
                }
            } else {
                usedPanel.style.display = 'none';
                nousePanel.style.display = 'none';
            }
        });


    });
</script>
{% endblock %}