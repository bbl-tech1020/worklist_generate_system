
{% extends 'dashboard/index.html' %}
{% block header %}
<header class="navbar navbar-expand-md navbar-light d-print-none">
    <div class="container-fluid">
        <h1 class="navbar-brand">参数列表</h1>
    </div>
</header>
<style>
    .table thead th,
    .table tbody td {
        font-size: 1.25rem;
        font-weight: bold;
        text-align: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <input id="live-search" type="text" class="form-control me-3" placeholder="输入以筛选：仪器编号 / 仪器厂家 / 系统号"
            style="max-width: 420px;">
        <a href="{% url 'vendor_config_create' %}" class="btn btn-primary">新建参数</a>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-bordered table-striped">
            <thead>
                <tr>
                    <th>仪器编号</th>
                    <th>仪器厂家</th>    
                    <th>系统号</th> 
                    <th>上传模板</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% for config in instrument_configs %}
                <tr>
                    <td>{{ config.instrument_num }}</td>
                    <td>{{ config.instrument_name }}</td>  
                    <td>{{ config.systerm_num }}</td>  
                    <td>
                        {% if config.upload_file %}
                            <a href="{{ config.upload_file.url }}" download>{{config.upload_file}}</a>
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        <a href="javascript:void(0);" class="text-danger ms-2 btn-delete" data-id="{{ config.pk }}">删除</a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="5" class="text-center text-muted">暂无参数，请点击“新建参数”添加</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.btn-delete').forEach(function(btn) {
            btn.addEventListener('click', function() {
                let pk = this.getAttribute('data-id');
                if (confirm("确认要删除此参数吗？")) {
                    fetch("{% url 'vendor_config_delete' 0 %}".replace('/0/', `/${pk}/`), {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': '{{ csrf_token }}',
                            'x-requested-with': 'XMLHttpRequest',
                        },
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert("删除失败：" + (data.error || ''));
                        }
                    });
                }
            });
        });
    });

    document.addEventListener("DOMContentLoaded", function () {
        // ……这里保留你现有的删除相关代码……

        // ====== 即时搜索（按三列筛：项目简称/项目全称/默认上机仪器）======
        const input = document.getElementById('live-search');
        const tbody = document.querySelector('table.table tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));

        // 哪些列参与筛选：0=项目简称，1=项目全称，5=默认上机仪器
        function matchRow(tr, kw) {
            const cells = tr.children;
            const a = (cells[0]?.textContent || '').toLowerCase();
            const b = (cells[1]?.textContent || '').toLowerCase();
            const c = (cells[2]?.textContent || '').toLowerCase();
            return a.includes(kw) || b.includes(kw) || c.includes(kw);
        }

        // 简单防抖，避免大数据时频繁计算
        let timer = null;
        input.addEventListener('input', function () {
            const val = this.value.trim().toLowerCase();
            clearTimeout(timer);
            timer = setTimeout(() => {
                rows.forEach(tr => {
                    if (!val) { tr.style.display = ''; return; }
                    tr.style.display = matchRow(tr, val) ? '' : 'none';
                });
            }, 100);
        });
    });
</script>

{% endblock %}


