<!-- dashboard/templates/dashboard/export_pdf.html -->

{% load static %}
<!doctype html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <style>
        /* 关键：横向页面 + 窄边距 */
        @page {
            size: A4 landscape;
            /* margin: 6mm 6mm 8mm 6mm; */
            margin: 4mm 4mm 10mm;   /* 适度页边距，保证内容装下一页 */
        }

        /* 每个 .pdf-page 占一整页 */
        .pdf-page {
            break-after: page;           /* CSS Fragmentation */
            page-break-after: always;    /* 兼容旧属性 */
        }

        body,
        table,
        td,
        th,
        div,
        span {
            font-family: "CN", "DejaVu Sans", sans-serif;
            font-size: 9pt;
            /* 整体字号稍小以便一页放下 */
            line-height: 1.25;
        }

        /* 96 孔板整体表格：固定布局，宽度用 mm 控制，避免超页 */
        .table-worksheet {
            border-collapse: collapse;
            page-break-inside: avoid;
        }

        .table-worksheet th,
        .table-worksheet td {
            border: 0.6pt solid #000;
            padding: 1pt;
            /* 压缩 padding 让内容更紧凑 */
            vertical-align: middle;
            word-wrap: break-word;
            /* 强制换行 */
            word-break: break-all;
            overflow: hidden;
            /* 隐藏溢出 */
        }

        .title {
            text-align: center;
            font-weight: bold;
            font-size: 12pt;
            padding: 4pt 0;
        }

        /* 第一列（A~H 行头）给一个固定宽度 */
        .table-worksheet .letters {
            width: 12mm;
            text-align: center;
            font-weight: bold;
        }

        /* 普通单元格固定高度，避免撑高导致跨页 */
        .table-worksheet .cell {
            height: 13mm;
            /* 根据需要微调 15~18mm */
        }

        /* 样本名/条码字号更小些 */
        .SampleName {
            font-size: 8pt;
            font-weight: 700;
        }

        .Barcode {
            font-size: 7pt;
        }

        .hole {
            font-size: 7pt;
            color: #333;
            font-weight: 800;
        }

        /* 定位孔显示（字号适中） */
        .locator {
            font-weight: 700;
            font-size: 16pt;
            text-align: center;
        }

        /* 备注表样式 */
        .note {
            font-size: 8pt;
        }

        .icon-flag {
            font-size: 12pt;
        }

        /* ⚑ */
        .icon-cubes {
            font-weight: 700;
        }

        /* ◆ */
        .icon-star {}

        /* ★ */

        /* 行、单元格尽量避免分页 */
        tr,
        td,
        th {
            page-break-inside: avoid;
            
        }

        /* 备注等小表（报错信息、说明） */
        .table-error {
            text-align: center;
            border-collapse: collapse;
            margin-top: 6mm;
        }

        .table-error th,
        .table-error td {
            border: 0.6pt solid #000;
            padding: 2pt;
            font-size: 8pt;
            word-break: break-all;
            overflow: hidden;
        }

        /* 表格统一宽度，避免超页 */
        .table-worksheet,
        .table-error {
            width: 100%;
            table-layout: fixed;
        }

        
    </style>
</head>

<body>

    <!-- 96孔板 -->
    <!-- 第 1 页：96 孔板工作清单 -->
    <section class="pdf-page">
        <table class="table-worksheet" cellpadding="2" cellspacing="0" border="0">
            <thead>
                <tr>
                    <th colspan="13" class="title">{{ project_name_full }}前处理样品工作单（Testing Worksheet）</th>
                </tr>
                <!-- ✅ 第二行：检测日期 / 板号 / 仪器编号 / 上机盘号 -->
                <tr class="meta-row">
                    <th colspan="2" style="text-align:left;">检测日期</th>
                    <th colspan="2" style="text-align:left;">{{ header.today_str }}</th>

                    <th colspan="2" style="text-align:left;">板号：{{ header.plate_no }}</th>

                    <th colspan="3" style="text-align:left;">检测仪器编号：{{ header.instrument_num }}</th>

                    <th colspan="2" style="text-align:left;">上机盘号：</th>
                    <th colspan="2" style="text-align:left;">{{ header.injection_plate }}</th>
                </tr>
                <tr class="maintext">
                    <th style="width: 28px;"></th>
                    {% for n in nums %}
                        <th style="text-align:center;">{{ n }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row_idx in worksheet_table %}
                <tr>
                    <td class="letters">{{ row_idx.0.letter }}</td>
                    {% for cell in row_idx %}
                    <td>
                        {% if cell.locator %}
                        <div class="locator">{{ cell.locator_warm }}</div>
                        {% else %}
                        <div class="hole">{{ cell.letter }}{{ cell.num }} ({{ cell.index }})</div>
                        
                        {% if cell.flag_suck == "1" %}<span class="icon-flag">▼</span>{% endif %}
                        {% if cell.flag_dispense == "1" %}<span class="icon-flag">▲</span>{% endif %}


                        <!-- 旗帜：warm 为 1/4/16384 -->
                        {% if cell.warm == "1" or cell.warm == "4" or cell.warm == "16384" %}
                            <span class="icon-flag">⚑</span>
                        {% endif %}

                        <!-- 条码一对多：◆ -->
                        {% if cell.dup_barcode == "TRUE" %}
                            <span class="icon-cubes">◆</span>
                        {% else %}
                            <span class="icon-cubes"><br></span>
                        {% endif %}

                        <!-- 条码在移液清单中重复且一对多：★  -->
                        {% if cell.dup_barcode_sample == "TRUE" %}
                            <span class="icon-star">★</span>
                        {% endif %}

                        {% if platform == 'Starlet' %}
                            {% if cell.cut_barcode == "NOTUBE" %}

                            {% else %}
                                <div class="SampleName">{{ cell.match_sample }}</div>
                                <div class="Barcode">{{ cell.cut_barcode }}</div>
                                <div class="Barcode">{{ cell.sub_barcode }}</div>
                            {% endif %}
                        {% else %}
                            <div class="SampleName">{{ cell.match_sample }}</div>
                            <div class="Barcode">{{ cell.cut_barcode }}</div>
                            <div class="Barcode">{{ cell.sub_barcode }}</div>
                        {% endif %}
                        {% endif %}
                    </td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
            <tfoot>
                <tr class="maintext">
                    <th colspan="3">加样枪：FXS-YY</th>
                    <th colspan="2">手工加样人员：</th>
                    <th colspan="3">加样情况审核人员：</th>
                    {% if platform == 'Starlet' %}
                        <th colspan="5">备注：
                            <span class="icon-flag">▼</span> 表示吸液报错，孔位可用；
                            <span class="icon-flag">▲</span> 表示打液报错，孔位不可用；
                            <br>
                            <span class="icon-cubes">◆</span> 表示该条码有多个实验号；
                            <span class="icon-star">★</span> 表示该条码在移液清单中有重复，且对应多个实验号。
                        </th>
                    {% else %}
                        
                        <th colspan="5">备注：
                            {% if platform != "Tecan" %}
                                <span class="icon-flag">⚑</span> 表示移液有问题；
                                <span class="icon-cubes">◆</span> 表示该条码有多个实验号；
                                <span class="icon-star">★</span> 表示该条码在移液清单中有重复，且对应多个实验号。
                            {% endif %}
                        </th>
                    {% endif %}
                </tr>
            </tfoot>
        </table>
    </section>
    <br />

    <!-- 第 2 页：报错信息表 -->
    {% if platform != "Tecan" %}
        <section>
            <table class="table-error" cellpadding="2" cellspacing="0" border="0">
                <thead>
                    <tr class="maintext">
                        <th>实验号</th>
                        <th>条码</th>
                        <th>板号</th>
                        <th>孔位</th>
                        <th>警告级别</th>
                        <th>警告信息</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in error_rows %}
                        {% if row.origin_barcode != 'NOTUBE' and row.origin_barcode != 'No match' %}
                            <tr>
                                <td>{{ row.sample_name }}</td>
                                <td>{{ row.origin_barcode }}</td>
                                <td>{{ row.plate_no }}</td>
                                <td>{{ row.well_str }}</td>
                                <td>{{ row.warn_level }}</td>
                                <td>{{ row.warn_info }}</td>
                            </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </section>
    {% endif %}

</body>

</html>