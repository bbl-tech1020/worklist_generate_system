{# dashboard/templates/dashboard/file_download.html #}
{% extends 'dashboard/index.html' %}
{% load static %}

{% block header %}
<header class="navbar navbar-expand-md navbar-light d-print-none">
  <div class="container-fluid">
    <h1 class="navbar-brand">æ–‡ä»¶ä¸‹è½½</h1>
  </div>
  {% include "dashboard/partials/user_toolbar.html" %}
</header>
<style>
  ul {
    list-style: none;
    padding-left: 20px
  }

  .folder {
    cursor: pointer;
    font-weight: 700;
    font-size: 18px;
    margin: 8px 0
  }

  .file {
    margin-left: 25px;
    font-size: 16px;
    color: #333;
    margin-top: 8px;
    display: block
  }

  .hidden {
    display: none
  }

  /* âœ… æ–°å¢ï¼šåŠ å¤§é¡¶çº§å¹³å°é—´è· */
  #fileTree>ul>li {
    margin-top: 25px;
  }

  /* âœ… ä»…åŠ å¤§ Starlet å†…éƒ¨ä¸€çº§ç›®å½•ä¹‹é—´çš„é—´è·ï¼ˆå·¥ä½œæ¸…å•å’Œä¸Šæœºåˆ—è¡¨ã€å–æ ·æŒ‡ä»¤ï¼‰ */
  #fileTree>ul>li:nth-child(2)>ul>li {
    margin-top: 18px;
    /* å¯è°ƒå¤§ï¼Œæ¯”å¦‚ 24px */
  }

  #fileTree>ul>li:nth-child(2)>ul>li:first-child {
    margin-top: 0;
    /* ç¬¬ä¸€ä¸ªï¼ˆå·¥ä½œæ¸…å•å’Œä¸Šæœºåˆ—è¡¨ï¼‰ä¸åŠ é¢å¤–é—´è· */
  }

  /* ===== æ–‡ä»¶æ“ä½œæŒ‰é’®åŒº ===== */
  .file-download-wrapper {
    position: relative;   /* ä½œä¸ºå®šä½å‚ç…§ */
  }

  /* æŒ‰é’®è„±ç¦»æ–‡æ¡£æµ */
  .file-action-bar {
    position: absolute;
    top: 0;
    right: 0;
    display: flex;
    gap: 16px;
  }

  /* æ–‡ä»¶æ ‘ä¸å†è¢«é¡¶ä¸‹æ¥ */
  #fileTree {
    margin-top: 0;
  }

  .file-action-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 8px 18px;
    font-size: 15px;
    font-weight: 600;
    border-radius: 6px;
    text-decoration: none;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .btn-replace {
    background-color: #e3f2fd;
    color: #1565c0;
    border: 1px solid #90caf9;
  }

  .btn-replace:hover {
    background-color: #bbdefb;
  }

  .btn-history {
    background-color: #f1f8e9;
    color: #33691e;
    border: 1px solid #aed581;
  }

  .btn-history:hover {
    background-color: #dcedc8;
  }
</style>
{% endblock %}

{% block content %}
<div class="file-download-wrapper">
  <div class="file-action-bar">
    <a href="{% url 'file_replace' %}" class="file-action-btn btn-replace">ğŸ”„ æ–‡ä»¶æ›¿æ¢</a>
    <a href="{% url 'file_download_history' %}" class="file-action-btn btn-history">ğŸ•˜ å†å²æ–‡ä»¶</a>
  </div>

  <div id="fileTree">
    <ul>
      {% for g in groups %}
      <li>
        <span class="folder">ğŸ“ {{ g.group }}</span>
        <ul class="hidden">

          <!-- Starletï¼ˆæœ‰ categoriesï¼‰ -->
          {% if g.categories %}
          {% for cat in g.categories %}
          <li>
            <span class="folder">ğŸ“ {{ cat.category }}</span>
            <ul class="hidden">
              {% for day in cat.days %}
              <li>
                <span class="folder">ğŸ“ {{ day.date }}</span>
                <ul class="hidden">

                  {# å–æ ·æŒ‡ä»¤ï¼šæ—¥æœŸä¸‹ç›´æ¥æ˜¯æ–‡ä»¶ #}
                  {% if day.files %}
                  {% for f in day.files %}
                  {% if f.force_download %}
                  <li><a class="file" href="{{ f.url }}" download="{{ f.name }}">ğŸ“„ {{ f.name }}</a></li>
                  {% else %}
                  <li><a class="file" href="{{ f.url }}" target="_blank">ğŸ“„ {{ f.name }}</a></li>
                  {% endif %}
                  {% empty %}
                  <li class="file">ï¼ˆæš‚æ— æ–‡ä»¶ï¼‰</li>
                  {% endfor %}
                  {% else %}
                  {# å·¥ä½œæ¸…å•å’Œä¸Šæœºåˆ—è¡¨ï¼šæ—¥æœŸä¸‹æœ‰é¡¹ç›®å±‚ #}
                  {% for proj in day.projects %}
                  <li>
                    <span class="folder">ğŸ“ {{ proj.name }}</span>
                    <ul class="hidden">
                      {% for f in proj.files %}
                      {% if f.force_download %}
                      <li><a class="file" href="{{ f.url }}" download="{{ f.name }}">ğŸ“„ {{ f.name }}</a></li>
                      {% else %}
                      <li><a class="file" href="{{ f.url }}" target="_blank">ğŸ“„ {{ f.name }}</a></li>
                      {% endif %}
                      {% empty %}
                      <li class="file">ï¼ˆæš‚æ— æ–‡ä»¶ï¼‰</li>
                      {% endfor %}
                    </ul>
                  </li>
                  {% endfor %}
                  {% endif %}

                </ul>
              </li>
              {% empty %}
              <li class="file">ï¼ˆæš‚æ— æ–‡ä»¶ï¼‰</li>
              {% endfor %}
            </ul>
          </li>
          {% endfor %}

          {% else %}
          <!--  å…¶ä»–å¹³å°ï¼ˆæ—§ä¸‰å±‚ï¼‰ -->
          {% for day in g.days %}
          <li>
            <span class="folder">ğŸ“ {{ day.date }}</span>
            <ul class="hidden">
              {% for proj in day.projects %}
              <li>
                <span class="folder">ğŸ“ {{ proj.name }}</span>
                <ul class="hidden">
                  {% for f in proj.files %}
                  {% if f.force_download %}
                  <li><a class="file" href="{{ f.url }}" download="{{ f.name }}">ğŸ“„ {{ f.name }}</a></li>
                  {% else %}
                  <li><a class="file" href="{{ f.url }}" target="_blank">ğŸ“„ {{ f.name }}</a></li>
                  {% endif %}
                  {% empty %}
                  <li class="file">ï¼ˆæš‚æ— æ–‡ä»¶ï¼‰</li>
                  {% endfor %}
                </ul>
              </li>
              {% endfor %}
            </ul>
          </li>
          {% empty %}
          <li class="file">ï¼ˆæš‚æ— æ–‡ä»¶ï¼‰</li>
          {% endfor %}
          {% endif %}

        </ul>
      </li>
      {% empty %}
      <li>æš‚æ— å¯¼å‡ºæ–‡ä»¶</li>
      {% endfor %}
    </ul>
  </div>
</div>

<script>
  document.querySelectorAll("#fileTree .folder").forEach(el => {
    el.addEventListener("click", () => {
      const next = el.nextElementSibling;
      if (next) next.classList.toggle("hidden");
    });
  });
</script>
{% endblock %}