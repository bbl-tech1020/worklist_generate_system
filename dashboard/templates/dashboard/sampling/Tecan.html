{% extends 'dashboard/index.html' %}
{% load static %}
{% block header %}
<header class="navbar navbar-expand-md navbar-light d-print-none">
  <div class="container-fluid">
    <h1 class="navbar-brand">Tecan取样</h1>
  </div>
</header>
{% endblock %}

{% block content %}
<div class="card mt-4">

  <div class="card-body">

    <!-- TECAN取样表单 -->
    <div id="Tecan-feature-group">
      <form action="{% url 'TecanIngest' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <input type="hidden" name="platform" value="TECAN">
        <div class="mb-3">
          <label class="form-label" name="project_id">项目名称</label>
          <select class="form-select" id="project-select" name="project_id" required>
            <option value="">请选择项目</option>
            <!-- 选项由js动态加载 -->
          </select>
          <input type="hidden" id="project-name" name="project_name">
        </div>

        <div class="mb-3">
          <label class="form-label">岗位清单表</label>
          <input type="file" class="form-control" name="station_list">
        </div>
        <div class="mb-3">
          <label class="form-label">扫码结果表</label>
          <input type="file" class="form-control" name="scan_result">
        </div>

        <!-- 上机仪器 -->
        <div class="mb-3">
          <label class="form-label">上机仪器</label>
          <input type="text" class="form-control" id="instrument_num" name="instrument_num" placeholder="请输入仪器编号">
        </div>

        <!-- 系统号 -->
        <div class="mb-3">
          <label class="form-label">系统号</label>
          <select class="form-select" id="systerm_num" name="systerm_num">
            <option value="">请选择</option>
            <option value="S0">S0</option>
            <option value="S1">S1</option>
            <option value="S2">S2</option>
            <option value="S3">S3</option>
            <option value="S4">S4</option>
          </select>
        </div>

        <!-- 进样盘号（按需显示） -->
        <div class="mb-3 d-none" id="plate-group">
          <label class="form-label">进样盘号</label>
          <select class="form-select" id="injection-plate-select" name="injection_plate">
            <option value="">请选择进样盘号</option>
          </select>
          <div class="form-text">当该项目与仪器在“进样盘号配置”中存在记录时，此项才会出现。</div>
        </div>

        <!-- 历史 processed 文件列表 -->
        <div class="card mt-3">
          <div class="card-header">
            <h3 class="card-title">当日历史文件（processed）</h3>
          </div>
          <div class="card-body">
            <div id="processed-list-empty" class="text-muted">尚无文件</div>
            <table id="processed-list-table" class="table" style="display:none;">
              <thead>
                <tr>
                  <th>文件名</th>
                  <th>大小</th>
                  <th>修改时间</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody id="processed-list-body"></tbody>
            </table>
          </div>
        </div>

        <div class="mt-4">
          <button type="submit" class="btn btn-primary">提交</button>
        </div>
      </form>
    </div>

  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 1. 加载项目列表
    fetch("{% url 'get_project_list' %}")
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('project-select');
        (data.projects || []).forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.name;
          select.appendChild(opt);
        });
      });

    // 2. 项目下拉联动“上机仪器”
    const projectSelect = document.getElementById('project-select');
    const instrumentInput = document.getElementById('instrument_num');

    // 用 Django 生成“带占位符的绝对 URL”
    // /dashboard/frontend_entry/get_project_detail/0/
    const detailUrlTemplate = "{% url 'get_project_detail' pk=0 %}";

    projectSelect.addEventListener('change', function () {
      const projectId = this.value;
      const projectName = this.options[this.selectedIndex]?.text || '';

      // 同步项目名称到隐藏字段
      document.getElementById('project-name').value = projectName;

      if (!projectId) { instrumentInput.value = ''; return; }

      // 把最后的 0/ 替换成真实的 projectId + 斜杠
      const detailUrl = detailUrlTemplate.replace(/0\/?$/, projectId + "/");

      fetch(detailUrl)
        .then(res => res.json())
        .then(data => {
          instrumentInput.value = data.default_upload_instrument || '';
          refreshPlateDropdown();
        });
    });

    // 监听项目切换，重新加载列表
    if (projectSelect) {
      projectSelect.addEventListener('change', loadProcessedList);
    }

    // 初次进入，若默认有选中，也加载一次
    loadProcessedList();
  });


  // 若你已有 getCookie 函数，可跳过
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(";").shift();
  }
  const csrftoken = getCookie("csrftoken");

  // 工具：格式化
  function fmtSize(bytes) {
    if (bytes == null) return "";
    const units = ["B", "KB", "MB", "GB"];
    let i = 0, v = Number(bytes);
    while (v >= 1024 && i < units.length - 1) { v /= 1024; i++; }
    return v.toFixed(1) + " " + units[i];
  }
  function fmtTime(ts) {
    if (!ts) return "";
    const d = new Date(ts * 1000);
    return d.toLocaleString();
  }

  // 拉取 processed 列表
  async function loadProcessedList() {
    const sel = document.getElementById('project-select');
    const pid = sel && sel.value;
    const pname = sel && sel.options[sel.selectedIndex] 
      ? sel.options[sel.selectedIndex].text.trim() 
      : "";
    if (!pid && !pname) return renderProcessedList([]);

    const params = new URLSearchParams({
      project_id: pid || "",
      project_name: pname || ""
    });
    const resp = await fetch("{% url 'TecanProcessedList' %}?" + params.toString(), {
      credentials: "same-origin"
    });
    const data = await resp.json();
    renderProcessedList((data && data.files) || []);
  }

  function renderProcessedList(files) {
    const empty = document.getElementById('processed-list-empty');
    const table = document.getElementById('processed-list-table');
    const body = document.getElementById('processed-list-body');
    body.innerHTML = "";

    if (!files || files.length === 0) {
      empty.style.display = "";
      table.style.display = "none";
      return;
    }
    empty.style.display = "none";
    table.style.display = "";

    files.forEach(f => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${f.name}</td>
        <td>${fmtSize(f.size)}</td>
        <td>${fmtTime(f.mtime)}</td>
        <td>
          <button type="button" class="btn btn-sm btn-outline-primary js-download" data-fn="${encodeURIComponent(f.name)}">下载</button>
          <button type="button" class="btn btn-sm btn-outline-danger ms-2 js-del" data-fn="${encodeURIComponent(f.name)}">删除</button>
          <button type="button" class="btn btn-sm btn-outline-secondary ms-2 js-mv" data-fn="${encodeURIComponent(f.name)}">移动到 backup</button>
        </td>`;
      body.appendChild(tr);
    });

    // 事件：下载
    body.querySelectorAll(".js-download").forEach(btn => {
      btn.addEventListener("click", (e) => {
        e.preventDefault();
        e.stopPropagation();

        const filename = decodeURIComponent(btn.dataset.fn);

        const sel = document.getElementById('project-select');
        const pid = sel && sel.value;
        const pname = sel && sel.options[sel.selectedIndex] 
          ? sel.options[sel.selectedIndex].text.trim()
          : "";

        const params = new URLSearchParams({
          project_id: pid || "",
          project_name: pname || "",
          filename: filename
        });

        // 跳转到后端下载接口
        window.location.href = "{% url 'TecanProcessedDownload' %}?" + params.toString();
      });
    });

    // 事件：删除
    body.querySelectorAll(".js-del").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        await manageProcessed(decodeURIComponent(btn.dataset.fn), "delete");
        btn.closest("tr")?.remove();
        if (body.children.length === 0) renderProcessedList([]);
      });
    });

    // 事件：移动
    body.querySelectorAll(".js-mv").forEach(btn => {
      btn.addEventListener("click", async (e) => {
        e.preventDefault(); e.stopPropagation();
        await manageProcessed(decodeURIComponent(btn.dataset.fn), "move");
        btn.closest("tr")?.remove();
        if (body.children.length === 0) renderProcessedList([]);
      });
    });
  }

  async function manageProcessed(filename, action) {
    const sel = document.getElementById('project-select');
    const pid = sel && sel.value;
    const pname = sel && sel.options[sel.selectedIndex] 
      ? sel.options[sel.selectedIndex].text.trim() 
      : "";

    const form = new FormData();
    form.append("project_id", pid || "");
    form.append("project_name", pname || "");
    form.append("filename", filename);
    form.append("action", action);

    const resp = await fetch("{% url 'TecanProcessedManage' %}", {
      method: "POST",
      credentials: "same-origin",
      headers: { "X-CSRFToken": csrftoken, "Accept": "application/json" },
      body: form
    });
    if (!resp.ok) {
      const text = await resp.text();
      throw new Error(text || "操作失败");
    }
  }

  // 封装一个刷新“进样盘号下拉”的函数
  function refreshPlateDropdown() {
    const selectProject = document.getElementById('project-select');
    const instrumentInput = document.getElementById('instrument_num');
    const systermSelect   = document.getElementById('systerm_num');

    const plateGroup = document.getElementById('plate-group');
    const plateSelect = document.getElementById('injection-plate-select');

    const projectName = selectProject.options[selectProject.selectedIndex]?.text || '';
    const instrumentNum = instrumentInput.value.trim();
    const systermNum    = systermSelect.value.trim();

    // 条件不足则隐藏并清空
    if (!projectName || !instrumentNum) {
      plateGroup.classList.add('d-none');
      plateSelect.innerHTML = '<option value="">请选择进样盘号</option>';
      return;
    }

    // 请求后端获取盘号
    fetch("{% url 'get_injection_plates' %}?project_name=" + encodeURIComponent(projectName) +
      "&instrument_num=" + encodeURIComponent(instrumentNum) + 
      (systermNum ? "&systerm_num=" + encodeURIComponent(systermNum) : ""))
      .then(res => res.json())
      .then(data => {
        const plates = data.plates || [];
        plateSelect.innerHTML = '<option value="">请选择进样盘号</option>';

        if (plates.length > 0) {
          plates.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            plateSelect.appendChild(opt);
          });
          plateGroup.classList.remove('d-none');
        } else {
          plateGroup.classList.add('d-none');
        }
      })
      .catch(() => {
        plateGroup.classList.add('d-none');
        plateSelect.innerHTML = '<option value="">请选择进样盘号</option>';
      });
  }

  // 项目变更 → 写入默认仪器后再刷新盘号
  document.getElementById('project-select').addEventListener('change', function () {
    const projectId = this.value;
    const projectName = this.options[this.selectedIndex]?.text || '';

    // 同步项目名称到隐藏字段
    document.getElementById('project-name').value = projectName;
    
    if (!projectId) return;

    fetch(`get_project_detail/${projectId}/`)
      .then(res => res.json())
      .then(data => {
        document.getElementById('instrument_num').value = data.default_upload_instrument || '';
        refreshPlateDropdown(); // 写入仪器后刷新盘号
      });
  });

  // 用户手动修改仪器时，也刷新盘号
  document.getElementById('instrument_num').addEventListener('input', refreshPlateDropdown);
  document.getElementById('systerm_num').addEventListener('change', refreshPlateDropdown);


</script>


{% endblock %}