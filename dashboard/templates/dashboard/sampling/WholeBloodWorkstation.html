{% extends 'dashboard/index.html' %}
{% load static %}
{% block header %}
<header class="navbar navbar-expand-md navbar-light d-print-none">
  <div class="container-fluid">
    <h1 class="navbar-brand">全血工作站取样</h1>
  </div>
  {% include "dashboard/partials/user_toolbar.html" %}
</header>
{% endblock %}

{% block content %}
<div class="card mt-4">

  <div class="card-body">

    <!-- NIMBUS取样表单 -->
    <div id="nimbus-feature-group">
      <form action="{% url 'WholeBloodWorkstationResult' %}" method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <input type="hidden" name="platform" value="NIMBUS">
        <div class="mb-3">
          <label class="form-label" name="project_id">项目名称</label>
          <select class="form-select" id="project-select" name="project_id" required>
            <option value="">请选择项目</option>
            <!-- 选项由js动态加载 -->
          </select>
          <input type="hidden" id="project-name" name="project_name">
        </div>

        <div class="mb-3">
          <label class="form-label">岗位清单表</label>
          <input type="file" class="form-control" name="station_list">
        </div>
        <div class="mb-3">
          <label class="form-label">取样总表</label>
          <input type="file" class="form-control" name="scan_result">
        </div>

        <!-- 上机仪器 -->
        <div class="mb-3">
          <label class="form-label">上机仪器</label>
          <input type="text" class="form-control" id="instrument_num" name="instrument_num" placeholder="请输入仪器编号">
        </div>

        <!-- 系统号 -->
        <div class="mb-3">
          <label class="form-label">系统号</label>
          <select class="form-select" id="systerm_num" name="systerm_num">
            <option value="">请选择</option>
          </select>
        </div>

        <!-- 进样盘号（按需显示） -->
        <div class="mb-3 d-none" id="plate-group">
          <label class="form-label">进样盘号</label>
          <select class="form-select" id="injection-plate-select" name="injection_plate">
            <option value="">请选择进样盘号</option>
          </select>
          <div class="form-text">当该项目与仪器在“进样盘号配置”中存在记录时，此项才会出现。</div>
        </div>

        <div class="mt-4">
          <button class="btn btn-primary">提交</button>
        </div>

      </form>
    </div>

  </div>
</div>


<script>
  document.addEventListener('DOMContentLoaded', function () {
    // 1. 加载项目列表
    fetch("{% url 'get_project_list' %}")
      .then(res => res.json())
      .then(data => {
        const select = document.getElementById('project-select');
        (data.projects || []).forEach(item => {
          const opt = document.createElement('option');
          opt.value = item.id;
          opt.textContent = item.name;
          select.appendChild(opt);
        });
      });

    // 2. 绑定事件（只绑定一次）
    document.getElementById('project-select').addEventListener('change', onProjectChange);
    document.getElementById('instrument_num').addEventListener('input', onInstrumentInput);
    document.getElementById('systerm_num').addEventListener('change', refreshPlateDropdown);

    // 系统号下拉提示
    document.getElementById('systerm_num').addEventListener('mousedown', onSystermMouseDown);
  });

  // === 项目变更：写入默认仪器 → 显式刷新系统号 → 刷新盘号 ===
  function onProjectChange() {
    const projectSelect = document.getElementById('project-select');
    const projectId = projectSelect.value;
    const projectName = projectSelect.options[projectSelect.selectedIndex]?.text || '';

    // 同步项目名称到隐藏字段
    document.getElementById('project-name').value = projectName;

    // 清空并重置（避免旧项目残留）
    document.getElementById('instrument_num').value = '';
    const systermSelect = document.getElementById('systerm_num');
    systermSelect.innerHTML = '<option value="">请选择</option>';
    systermSelect.dataset.hasConfig = "0";

    if (!projectId) {
      refreshPlateDropdown();
      return;
    }

    // 这里建议用 Django URL（更稳），不要用相对路径
    const detailUrlTemplate = "{% url 'get_project_detail' pk=0 %}";
    const detailUrl = detailUrlTemplate.replace(/0\/?$/, projectId + "/");

    fetch(detailUrl)
      .then(res => res.json())
      .then(data => {
        // 1) 自动写入仪器
        document.getElementById('instrument_num').value = data.default_upload_instrument || '';

        // 2) 显式刷新系统号（关键：不能依赖 input 事件）
        refreshSystermDropdown();

        // 3) 再刷新盘号
        refreshPlateDropdown();
      });
  }

  // === 用户手动修改仪器：刷新系统号 + 刷新盘号 ===
  function onInstrumentInput() {
    refreshSystermDropdown();
    refreshPlateDropdown();
  }

  // === 关联系统号 ===
  function refreshSystermDropdown() {
    const projectSelect   = document.getElementById('project-select');
    const instrumentInput = document.getElementById('instrument_num');
    const systermSelect   = document.getElementById('systerm_num');

    const projectName   = projectSelect.options[projectSelect.selectedIndex]?.text || '';
    const instrumentNum = instrumentInput.value.trim();

    // 重置
    systermSelect.innerHTML = '<option value="">请选择</option>';
    systermSelect.dataset.hasConfig = "0";

    // 条件不足不查
    if (!projectName || !instrumentNum) return;

    fetch("{% url 'get_systerm_nums' %}?project_name=" + encodeURIComponent(projectName) +
          "&instrument_num=" + encodeURIComponent(instrumentNum))
      .then(res => res.json())
      .then(data => {
        const nums = data.systerm_nums || [];
        if (nums.length > 0) {
          nums.forEach(n => {
            const opt = document.createElement('option');
            opt.value = n;
            opt.textContent = n;
            systermSelect.appendChild(opt);
          });
          systermSelect.dataset.hasConfig = "1";

          // ✅ 关键新增：如果只有一个系统号，自动选中
          if (nums.length === 1) {
            systermSelect.value = nums[0];

            // 自动选中系统号后，联动刷新进样盘号
            refreshPlateDropdown();
          }

        } else {
          systermSelect.dataset.hasConfig = "0";
        }
      })
      .catch(() => {
        systermSelect.dataset.hasConfig = "0";
      });
  }

  // === 刷新进样盘号 ===
  function refreshPlateDropdown() {
    const selectProject    = document.getElementById('project-select');
    const instrumentInput  = document.getElementById('instrument_num');
    const systermSelect    = document.getElementById('systerm_num');

    const plateGroup  = document.getElementById('plate-group');
    const plateSelect = document.getElementById('injection-plate-select');

    const projectName  = selectProject.options[selectProject.selectedIndex]?.text || '';
    const instrumentNum = instrumentInput.value.trim();
    const systermNum    = systermSelect.value.trim();

    // 条件不足则隐藏并清空
    if (!projectName || !instrumentNum) {
      plateGroup.classList.add('d-none');
      plateSelect.innerHTML = '<option value="">请选择进样盘号</option>';
      return;
    }

    fetch("{% url 'get_injection_plates' %}?project_name=" + encodeURIComponent(projectName) +
          "&instrument_num=" + encodeURIComponent(instrumentNum) +
          (systermNum ? "&systerm_num=" + encodeURIComponent(systermNum) : ""))
      .then(res => res.json())
      .then(data => {
        const plates = data.plates || [];
        plateSelect.innerHTML = '<option value="">请选择进样盘号</option>';

        if (plates.length > 0) {
          plates.forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            plateSelect.appendChild(opt);
          });
          plateGroup.classList.remove('d-none');
        } else {
          plateGroup.classList.add('d-none');
        }
      })
      .catch(() => {
        plateGroup.classList.add('d-none');
        plateSelect.innerHTML = '<option value="">请选择进样盘号</option>';
      });
  }

  // === 系统号下拉提示 ===
  function onSystermMouseDown() {
    const projectSelect = document.getElementById('project-select');
    const instrumentNum = document.getElementById('instrument_num').value.trim();
    const projectName = projectSelect.options[projectSelect.selectedIndex]?.text || '';

    if (!projectName || !instrumentNum) {
      alert("请先选择项目名称并填写上机仪器，再选择系统号。");
      return;
    }
    if (this.dataset.hasConfig !== "1") {
      alert("该项目 + 上机仪器未在【项目参数配置】中设置系统号，请先去后台配置。");
    }
  }
</script>



{% endblock %}